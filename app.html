<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
    </head>
    <body>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdn.jsdelivr.net/npm/csv-js@1.0.0/csv.min.js"></script>
        <div id="app">
            <ul>
                <li>
                    R: start record
                </li>
                <li>
                    R (again): stop record
                </li>
                <li>
                    P: play record
                </li>
            </ul>
            <input type="text" id="csv-file-url" style="width: 700px"></input>
            <button id="parse-btn">Parse</button>
            <button id="download-all">Download all sounds</button>
            <table id="words" border="solid 1px gray">
                <thead>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    <script>
        const playTemplate = '<svg class="play-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-play" viewBox="0 0 16 16"><path d="M6 10.117V5.883a.5.5 0 0 1 .757-.429l3.528 2.117a.5.5 0 0 1 0 .858l-3.528 2.117a.5.5 0 0 1-.757-.43z"/> <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1"/></svg>'

        const micTemplate = '<svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16"> <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0z"/> <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"/> </svg>'

        var wordToRow = function(wordElem) {
            return '<tr id="' + wordElem.record[1] + '">'
                + '<td>' + wordElem.record[1] + '</td>'
            + '</tr>'
        }

        const csvElemToTr = function(csvElem) {
            const ret = ['<tr>']
            for (const element of csvElem) {
                ret.push('<td>' + element + '</td>')
            }
            ret.push('</tr>')
            return ret.join('')
        }

        $(document).ready(function(){

            let audioRecorder;

            let currentCell = [0, 0]

            let isRecording = false

            // All sounds collection.
            let sounds = {}

            const parse = function(v) {
                const parsed = CSV.parse(v)
                for (const elem of parsed) {
                    $(csvElemToTr(elem)).appendTo($('#words tbody'))
                }
            }

            const error = function(err) {
                $('#words tbody tr').empty()
                alert(err)
            }

            $('#download-all').click(function() {
                const csvFileUrl = $('#csv-file-url').val()
                const filename = csvFileUrl.split('/').pop()
                const csvFileName = filename.split('.')[0]
                for (var key of Object.keys(sounds)) {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(sounds[key][0])
                    a.download = csvFileName + "_" + key + ".ogg";
                    a.click();
                }
            })

            $('#parse-btn').click(function() {
                $('#words tbody tr').empty()
                const csvFileUrl = $('#csv-file-url').val()
                const response = fetch(csvFileUrl)
                   .then(response => response.text())
                   .then(parse)
                   .catch(error)
            });

            const moveDown = function() {
                if (currentCell[0] === $('tr').length - 1) {
                    console.log('Nope')
                } else {
                    currentCell[0] += 1
                }
                $('tr td').css({'background-color': ''});
                const $tr = $('tr').eq(currentCell[0])
                const $td = $('td', $tr).eq(currentCell[1])
                $td.css({'background-color':'red'})
                $('html,body').animate({
                    scrollTop: $td.offset().top - $(window).height()/2
                }, 100);
            }

            const moveUp = function() {
                if (currentCell[0] == 0) {
                    console.log('Nope')
                } else {
                    currentCell[0] -= 1
                }
                $('tr td').css({'background-color': ''});
                const $tr = $('tr').eq(currentCell[0])
                const $td = $('td', $tr).eq(currentCell[1])
                $td.css({'background-color':'red'})
                $('html,body').animate({
                    scrollTop: $td.offset().top - $(window).height()/2
                }, 100);
            }

            const moveLeft = function() {
                $('tr td').css({'background-color': ''});
                const $tr = $('tr').eq(currentCell[0])
                if (currentCell[1] == 0) {
                    console.log('Nope')
                } else {
                    currentCell[1] -= 1
                }
                const $td = $('td', $tr).eq(currentCell[1])
                $td.css({'background-color':'red'})
            }

            const moveRight = function() {
                $('tr td').css({'background-color': ''});
                const $tr = $('tr').eq(currentCell[0])
                if (currentCell[1] === $('td', $tr).length - 1) {
                    console.log('Nope')
                } else {
                    currentCell[1] += 1
                }
                const $td = $('td', $tr).eq(currentCell[1])
                $td.css({'background-color':'red'})
            }

            const playCurrent = function() {
                const $tr = $('tr').eq(currentCell[0])
                const $td = $('td', $tr).eq(currentCell[1])

                const word = $td.text().trim()
                let audioChunks = sounds[word]
                const blobObj = new Blob(audioChunks, { type: 'audio/webm' })
                const audioUrl = URL.createObjectURL(blobObj)
                const audio = new Audio(audioUrl)
                audio.play()
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioRecorder = new MediaRecorder(stream);

                    audioRecorder.addEventListener("dataavailable", e => {
                        // recording stopped, data ready
                        const $tr = $("tr").eq(currentCell[0])
                        const $td = $("td", $tr).eq(currentCell[1])
                        $(playTemplate).appendTo($td)
                        const word = $td.text().trim()
                        sounds[word] = [e.data]
                    });

                    $(document).on("keydown", function(event) {
                        if (event.which === 74) {
                            // j, move down
                            moveDown()
                        } else if (event.which === 75) {
                            // k, move up
                            moveUp()
                        } else if (event.which === 72) {
                            // h, move left
                            moveLeft()
                        } else if (event.which === 76) {
                            // l, move right
                            moveRight()
                        } else if (event.which === 80) {
                            playCurrent()
                        } else if (event.which === 82) {
                            // r,start or stop recording.
                            if (isRecording) {
                                isRecording = false
                                $("#mic-icon").remove()
                                $("#record-flag").remove()
                                audioRecorder.stop()
                            } else {
                                isRecording = true
                                const $tr = $('tr').eq(currentCell[0])
                                const $currentCell = $("td", $tr).eq(currentCell[1])
                                const $mic = $(micTemplate)
                                $mic.appendTo($currentCell)
                                // If recording starts immediately buttons sound will be recorded as well,
                                // so start recording after a while.
                                const startRecording = function() {
                                    $("<span id=\"record-flag\">Now!</span>").appendTo($currentCell)
                                    audioRecorder.start()
                                }
                                setTimeout(startRecording, 500)
                                // audioRecorder.start()

                                // Do not allow to record too long sounds.
                                setTimeout(function() {$("#record-flag").remove(), audioRecorder.stop()}, 10000)
                            }
                        }
                    });
                }).catch(err => {
                    // If the user denies permission to record audio, then display an error.
                    console.log('Error: ' + err);
                });
            });
        </script>
    </body>
</html>
